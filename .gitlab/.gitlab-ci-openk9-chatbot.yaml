################################################################################
#                                   STAGES                                     #
################################################################################

stages:
- build
- build-verifier
- container-scanning
- dependency-check
- restart
- publish

include:
- local: "/.gitlab/.gitlab-templates.yaml"

################################################################################
#                                    JOBS                                       #
################################################################################

#################
# Fetch Version #
#################
Fetch version:
  stage: build
  image: node:20.9.0-alpine
  script:
  - cd js-packages/openk9-chatbot
  - export VERSION=$(node -p "require('./package.json').version")
  - echo "VERSION=$VERSION" > $CI_PROJECT_DIR/version.env
  artifacts:
    paths:
    - version.env
    expire_in: 1 day
  rules:
  # Run on merge requests and main branch only
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  - if: '$CI_COMMIT_BRANCH == "main"'

######################## BUILD VERIFIER ########################
Build Verifier:
  stage: build-verifier
  image: node:20.9.0
  cache:
    key: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}"
    paths:
    - js-packages/openk9-chatbot/node_modules
    - .yarn-cache
    policy: pull-push
  needs:
  - job: Fetch version
    artifacts: true
  script:
  - cd js-packages/openk9-chatbot
  # Set Node memory limit to 8GB to prevent OOM
  - export NODE_OPTIONS="--max-old-space-size=8192"
  # Yarn configuration for resilience:
  # - registry: Use reliable npmjs.org registry as fallback
  # - network-timeout: Increase timeout to 10m (600000ms) for slow networks
  # - cache-folder: Store cache in .yarn-cache to reuse between jobs
  # - prefer-offline: Use cached packages if available to reduce network calls
  # - frozen-lockfile: Ensure dependencies match yarn.lock exactly (reproducibility)
  - yarn config set registry https://registry.npmjs.org/
  - yarn config set network-timeout 600000
  - yarn config set cache-folder ../../.yarn-cache
  - yarn install --prefer-offline --frozen-lockfile
  - yarn build
  rules:
  # Run on merge requests and main branch only
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  - if: '$CI_COMMIT_BRANCH == "main"'

######################## BUILD OPENK9-CHATBOT (MAIN ONLY) ########################
Build OpenK9-Chatbot:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [ "" ]
  variables:
    DOCKER_CONFIG: "/kaniko/.docker"
  needs:
  - job: Fetch version
    artifacts: true
  script:
  # Docker credentials configuration
  - export NODE_OPTIONS="--max-old-space-size=8192"
  - mkdir -p /kaniko/.docker
  - |
    echo "{\"auths\":{\"registry.smc.it:49083\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USERNAME}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" \
    > /kaniko/.docker/config.json

  # Use version from package.json for main branch
  - source $CI_PROJECT_DIR/version.env
  - echo "=== Building OpenK9-Chatbot with VERSION=$VERSION ==="

  # Execute build
  - |
    /kaniko/executor \
      --context "${CI_PROJECT_DIR}" \
      --dockerfile "${CI_PROJECT_DIR}/js-packages/openk9-chatbot/Dockerfile" \
      --destination "$CI_REGISTRY_NAME/openk9/openk9-chatbot:$VERSION" \
      --build-arg NODE_OPTIONS="--max-old-space-size=8192"
  rules:
  # Only run on main branch
  - if: '$CI_COMMIT_BRANCH == "main"'
    changes:
    - js-packages/openk9-chatbot/**/*

######################## CONTAINER SCANNING ########################
Container Scanning:
  stage: container-scanning
  image: $CI_TEMPLATE_REGISTRY_HOST/security-products/container-scanning:latest
  dependencies:
  - "Fetch version"
  - "Build OpenK9-Chatbot"
  script:
  - source version.env
  - echo "=== Scanning image $CI_REGISTRY_NAME/openk9/openk9-chatbot:$VERSION ==="
  - gtcs scan --image "$CI_REGISTRY_NAME/openk9/openk9-chatbot:$VERSION"
  rules:
  - if: '$CI_COMMIT_BRANCH == "main"'

####################### PUBLISH OPENK9-CHATBOT #######################
Publish OpenK9-Chatbot:
  stage: publish
  image: node:20.9.0
  needs:
  - job: Build Verifier
  - job: Build OpenK9-Chatbot
  script:
  - cd js-packages/openk9-chatbot
  - pwd
  - whoami
  # Set Node memory limit to 8GB
  - export NODE_OPTIONS="--max-old-space-size=8192"
  # Yarn configuration for resilience (registry omitted to use publish target):
  # - network-timeout: Increase timeout to 10m (600000ms)
  # - cache-folder: Store cache in .yarn-cache
  # - prefer-offline: Use cached packages if available
  # - frozen-lockfile: Exact versions
  - yarn config set network-timeout 600000
  - yarn config set cache-folder ../../.yarn-cache
  - yarn install --prefer-offline --frozen-lockfile
  - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
  - npm publish --access public
  rules:
  - if: '$CI_COMMIT_BRANCH == "main"'
    changes:
    - js-packages/openk9-chatbot/**/*

####################### DEPENDENCY CHECK #######################
Dependency Check OpenK9-Chatbot:
  stage: dependency-check
  needs:
  - job: Publish OpenK9-Chatbot
  extends: .dependency_check_frontend_template
  allow_failure: true
  script:
  - cd js-packages/openk9-chatbot
  - /analyzer run
  rules:
  - if: '$CI_COMMIT_BRANCH == "main"'