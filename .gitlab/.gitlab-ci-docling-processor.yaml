################################################################################
#                           STAGES, VARIABLES & INCLUDE                         #
################################################################################

stages:
- build

variables:
  # Placeholder for future use if needed
  PYTHON_IMAGE_VERSION: "3.11"

include:
- local: '/.gitlab/.gitlab-templates.yaml'

################################################################################
#                                   JOBS                                        #
################################################################################

Fetch config:
  stage: build
  image: alpine:3.16
  script:
  - apk add --no-cache grep
  - VERSION=$(grep '^OPENK9_VERSION=' python_modules_config.txt | cut -d '=' -f2)
  # Extract PYTHON_BASE_DOCKER_IMAGE value from config file
  - PYTHON_BASE_DOCKER_IMAGE=$(grep '^PYTHON_BASE_DOCKER_IMAGE=' python_modules_config.txt | cut -d '=' -f2)
  # Write results to .env file
  - echo "VERSION=$VERSION" > "$CI_PROJECT_DIR/config.env"
  - echo "PYTHON_BASE_DOCKER_IMAGE=$PYTHON_BASE_DOCKER_IMAGE" >> "$CI_PROJECT_DIR/config.env"
  artifacts:
    paths:
    - config.env
    expire_in: 1 day

######################## BUILD DOCLING IMAGE (KANIKO) ########################
Build Docling Image:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [ "" ]
  needs:
  - job: Fetch config
    artifacts: true
  script:
  - source $CI_PROJECT_DIR/config.env
  - echo "=== Configuring Kaniko credentials ==="
  - mkdir -p /kaniko/.docker
  - |
    echo "{\"auths\":{\"registry.smc.it:49083\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USERNAME}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" \
    > /kaniko/.docker/config.json
  - |
    if [ "$CI_COMMIT_BRANCH" = "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
      echo "[DOCLING] Build & push as :$VERSION"
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}/enrichers/docling-processor/enricher" \
        --dockerfile "${CI_PROJECT_DIR}/enrichers/docling-processor/enricher/Dockerfile" \
        --destination "${CI_REGISTRY_NAME}/openk9/docling-processor:$VERSION" \
        --build-arg PYTHON_BASE_DOCKER_IMAGE=$PYTHON_BASE_DOCKER_IMAGE \
        --cache=true \
        --cache-repo="${CI_REGISTRY_NAME}/openk9/docling-processor-cache"
    elif [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ]; then
      echo "[DOCLING] Build & push as :merge-request"
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}/enrichers/docling-processor/enricher" \
        --dockerfile "${CI_PROJECT_DIR}/enrichers/docling-processor/enricher/Dockerfile" \
        --destination "${CI_REGISTRY_NAME}/openk9/docling-processor:$VERSION" \
        --build-arg PYTHON_BASE_DOCKER_IMAGE=$PYTHON_BASE_DOCKER_IMAGE \
        --cache=true \
        --cache-repo="${CI_REGISTRY_NAME}/openk9/docling-processor-cache"
    elif echo "$CI_COMMIT_BRANCH" | grep -qE '^[0-9]+-.*$'; then
      echo "[DOCLING] Feature branch => build & push :999-SNAPSHOT"
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}/enrichers/docling-processor/enricher" \
        --dockerfile "${CI_PROJECT_DIR}/enrichers/docling-processor/enricher/Dockerfile" \
        --destination "${CI_REGISTRY_NAME}/openk9/docling-processor:999-SNAPSHOT" \
        --build-arg PYTHON_BASE_DOCKER_IMAGE=$PYTHON_BASE_DOCKER_IMAGE \
        --cache=true \
        --cache-repo="${CI_REGISTRY_NAME}/openk9/docling-processor-cache"
    fi
  rules:
  - if: '$CI_COMMIT_BRANCH == "main"'
  - if: '$CI_COMMIT_TAG'
  - if: '$CI_COMMIT_BRANCH =~ /^[0-9]+-.*$/'
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
